name: Disable / Enable Landing Zone

on:
  workflow_dispatch:
    inputs:
      landingzoneId:
        required: true
        type: string
        description: 'Id of the landing zone to disable'
      activate:
        required: true
        type: boolean
        description: 'Activate disabled landing zone?'
        default: false

permissions:
  id-token: write
  contents: read
  
jobs:
  cancelLandingZone:
    runs-on: ubuntu-latest
    environment:  prod
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: get github token
      id: github-token
      uses: actions/create-github-app-token@v1
      with:
        app-id: ${{ vars.APP_GITHUB_BIGBANG_ID }}
        private-key: ${{ secrets.APP_GITHUB_BIGBANG }}
        owner: ${{ github.repository_owner }}

    - name: Azure login
      uses: azure/login@v2
      with:
        client-id: ${{ vars.AZURE_PLATFORM_CLIENT_ID }}
        tenant-id: ${{ vars.AZURE_TENANT_ID}}
        allow-no-subscriptions: true
        enable-AzPSSession: false

    - name: fetch landing zone name
      uses: azure/cli@v2
      with:
        inlineScript: |
            lzName=$(az account subscription show --id ${{ inputs.landingzoneId }} --query 'displayName' -o tsv)
            echo "LandingZoneName=$lzName" >> $GITHUB_ENV

   
    - name: cancel landing zone
      if: ${{ inputs.activate == false }}
      uses: azure/cli@v2
      with:
        inlineScript: |
            # az account subscription cancel --subscription-id ${{ inputs.landingzoneId }} --yes

    - name: disable landingzone workflow
      if: ${{ inputs.activate == false }}
      env:
        GH_TOKEN: ${{ steps.github-token.outputs.token }}
      run: |
        gh workflow disable 'lz - ${{ env.LandingZoneName }}'

    - name: reactivate landing zone
      if: ${{ inputs.activate == true }}
      uses: azure/cli@v2
      with:
        inlineScript: |
            # az account subscription enable --subscription-id ${{ inputs.landingzoneId }}

    - name: enable landingzone workflow
      if: ${{ inputs.activate == true }}
      env:
        GH_TOKEN: ${{ steps.github-token.outputs.token }}
      run: |
        gh workflow enable 'lz - ${{ env.LandingZoneName }}'